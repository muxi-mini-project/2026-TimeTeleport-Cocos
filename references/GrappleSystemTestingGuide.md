# 钩爪系统测试指南

## 概述

本指南介绍如何在不需要绳索绘制的情况下测试钩爪功能的核心移动逻辑。

## 准备工作

### 1. 基本配置
- [x] 确保 Player 节点有 `GrappleController` 组件
- [x] 确保 Player 节点有 `RigidBody2D` 组件
- [x] 确保 LevelMapManager 已绑定 `anchorPrefab`
- [x] 确保 TiledMap 中有 "anchor" 对象

### 2. 锚点测试位置
推荐在以下位置测试：
- 地图起始点附近
- 地图中央位置
- 地图高处位置（测试钩爪攀爬）

## 无绳索测试配置

### 快速测试设置（推荐）

**Player 节点的 GrappleController 组件：**
```
Grapple Enabled:      ✓ 勾选（启用钩爪）
Debug Log:            ✓ 勾选（显示日志）
Draw Rope:            □ 取消勾选（不绘制绳索）
Grapple Speed:        15（默认值）
Grapple Force:        50（默认值）
Reach Distance:       10（默认值）
Reset Dash On Grapple: ✓ 勾选（钩爪后重置冲刺）
```

**Anchor 组件的设置：**
```
Detection Radius:     200（默认值）
Debug Draw:           ✓ 勾选（显示检测范围）
Indicator Anim Duration: 0.3（默认值）
Player Node Ref:      （留空自动查找）
```

## 测试步骤

### 步骤 1: 启动游戏
1. 运行场景
2. 查看控制台确认初始化成功：
   ```
   [Grapple] GrappleController 组件已加载
   [Grapple] 钩爪功能已启用
   [PlayerController] GrappleController 已正确绑定
   ```

### 步骤 2: 确认锚点生成
1. 查看控制台确认锚点生成：
   ```
   生成对象 [anchor] 位置 x:0 y:224
   [Anchor] 成功找到 Player 节点
   ```

### 步骤 3: 验证检测范围
1. 控制玩家走到锚点附近（200像素内）
2. 观察控制台日志：
   ```
   [Anchor] 玩家进入范围，开始显示指示器
   ```
3. 如果勾选了 Anchor 的 `Debug Draw`，应该看到黄色检测圆圈

### 步骤 4: 测试钩爪触发
1. 确认玩家在锚点范围内
2. 按 L 键
3. 观察控制台日志：
   ```
   [Grapple] 按下 L 键
   [Grapple] 尝试使用钩爪
   [Grapple] 开始查找最近的锚点
   [Grapple] 找到 5 个 Anchor 组件
   [Grapple] 锚点 anchor 在范围内，检查距离
   [Grapple] 锚点 anchor 距离: 150.23
   [Grapple] 找到最近的锚点: anchor，距离 150.23
   [Grapple] 开始钩爪！
   [Grapple] 目标锚点: anchor
   [Grapple] 钩爪速度: 15
   ```

### 步骤 5: 观察玩家移动
1. 玩家应该向锚点方向移动
2. 移动加速平滑（物理力驱动）
3. 钩爪期间不受重力影响
4. 到达锚点附近后：
   ```
   [Grapple] 到达目标，保持动量！
   [Grapple] 已恢复重力
   [Grapple] 冲刺次数已重置（如果启用）
   [PlayerController] 冲刺次数已重置（如果启用）
   ```

### 步骤 6: 测试冲刺重置
1. 确认 `Reset Dash On Grapple` 已勾选
2. 按 L 键触发钩爪
3. 到达锚点后立即按 K 键冲刺
4. **预期结果**: 冲刺成功
5. 查看日志：
   ```
   [Grapple] 冲刺次数已重置
   [PlayerController] 冲刺次数已重置
   ```

## 测试用例

### 用例 1: 基础水平移动
**目标**: 测试玩家水平方向钩爪移动

**步骤**:
1. 在锚点右侧 150 像素处放置玩家
2. 按 L 键
3. **预期结果**: 玩家向左移动到锚点

**检查点**:
- ✓ 玩家移动方向正确
- ✓ 移动加速平滑
- ✓ 钩爪期间不受重力影响
- ✓ 到达后保持水平动量

### 用例 2: 垂直攀爬移动
**目标**: 测试玩家向上钩爪移动

**步骤**:
1. 在锚点下方 150 像素处放置玩家
2. 按 L 键
3. **预期结果**: 玩家向上移动到锚点

**检查点**:
- ✓ 玩家向上移动
- ✓ 移动加速平滑
- ✓ 钩爪期间不受重力影响
- ✓ 到达后保持向上动量（可能跳跃）

### 用例 3: 斜向移动
**目标**: 测试玩家斜向钩爪移动

**步骤**:
1. 在锚点斜下方 150 像素处放置玩家
2. 按 L 键
3. **预期结果**: 玩家向锚点斜向移动

**检查点**:
- ✓ 玩家同时向水平和垂直方向移动
- ✓ 移动轨迹为直线
- ✓ 移动加速平滑
- ✓ 钩爪期间不受重力影响
- ✓ 到达后保持斜向动量

### 用例 4: 多锚点选择
**目标**: 测试自动选择最近的锚点

**步骤**:
1. 放置 3 个锚点：左侧、右侧、上方
2. 玩家站在中间
3. 按 L 键
4. **预期结果**: 选择最近的锚点

**检查点**:
- ✓ 控制台显示距离计算
- ✓ 选择距离最小的锚点
- ✓ 移动到正确的锚点

### 用例 5: 超出范围无响应
**目标**: 测试超出范围时不触发钩爪

**步骤**:
1. 玩家站在锚点 300 像素外
2. 按 L 键
3. **预期结果**: 不触发钩爪

**检查点**:
- ✓ 控制台显示 `[Grapple] 未找到可用的锚点`
- ✓ 玩家不移动
- ✓ 不显示绳索（即使开启）

### 用例 6: 连续钩爪
**目标**: 测试连续多次钩爪

**步骤**:
1. 放置 2 个相邻的锚点
2. 玩家靠近第一个锚点，按 L 键
3. 到达后，靠近第二个锚点，按 L 键
4. **预期结果**: 可以连续钩爪

**检查点**:
- ✓ 每次钩爪独立工作
- ✓ 到达第一个后可以立即钩爪第二个
- ✓ 动量正确传递

### 用例 7: 钩爪中移动
**目标**: 测试钩爪过程中玩家输入

**步骤**:
1. 触发钩爪开始移动
2. 在移动过程中按方向键
3. **预期结果**: 玩家输入被忽略

**检查点**:
- ✓ 钩爪持续施加力
- ✓ 物理力主导移动
- ✓ 不受移动键影响
- ✓ 正确到达锚点

### 用例 8: 钩爪后冲刺重置
**目标**: 测试钩爪完成后冲刺次数自动重置

**步骤**:
1. 确认 `Reset Dash On Grapple` 已勾选
2. 在锚点附近按 L 键触发钩爪
3. 等待钩爪到达锚点
4. 按 K 键尝试冲刺
5. **预期结果**: 冲刺成功

**检查点**:
- ✓ 控制台显示 `[Grapple] 冲刺次数已重置`
- ✓ 控制台显示 `[PlayerController] 冲刺次数已重置`
- ✓ 可以立即使用冲刺
- ✓ 冲刺速度和距离正常

### 用例 9: 关闭冲刺重置
**目标**: 测试关闭冲刺重置功能

**步骤**:
1. 取消勾选 `Reset Dash On Grapple`
2. 在锚点附近按 L 键触发钩爪
3. 等待钩爪到达锚点
4. 按 K 键尝试冲刺
5. **预期结果**: 无法冲刺（如果之前已使用过冲刺）

**检查点**:
- ✓ 控制台不显示 `[Grapple] 冲刺次数已重置`
- ✓ 冲刺功能保持原状态
- ✓ 配置正确生效

## 调试技巧

### 1. 使用 Debug Draw
- 在 Anchor 组件中勾选 `Debug Draw`
- 可视化看到检测范围
- 确认玩家是否在范围内

### 2. 查看完整日志
- 确保 `Debug Log` 已勾选
- 查看每一步的执行情况
- 确认哪个环节出问题

### 3. 调整测试参数
**简单测试**:
```
Detection Radius:   500（增大范围，更容易测试）
Grapple Speed:      10（降低速度，容易观察）
Grapple Force:      30（降低拉力，更容易观察加速）
```

**精确测试**:
```
Detection Radius:   200（标准值）
Grapple Speed:      15（标准值）
Grapple Force:      50（标准值）
```

**极端测试**:
```
Detection Radius:   50（极小范围，测试精确度）
Grapple Speed:      50（极高速度，测试稳定性）
Grapple Force:      80（高拉力，快速响应）
```

### 4. 使用场景工具
- 在 Cocos Creator 中使用 `Scene Gizmo`
- 查看锚点的实际位置
- 确认玩家的世界坐标

## 常见问题诊断

### 问题 1: 按 L 键没有任何反应
**检查清单**:
- [ ] `Grapple Enabled` 是否勾选
- [ ] 是否有 `[Grapple] 按下 L 键` 日志
- [ ] `GrappleController` 是否正确绑定到 `PlayerController`

**解决方案**:
- 勾选 `Grapple Enabled`
- 检查 PlayerController 的 GrappleController 属性是否拖入正确

### 问题 2: 显示未找到锚点
**检查清单**:
- [ ] 玩家是否在 200 像素范围内
- [ ] 是否有 `[Anchor] 玩家进入范围` 日志
- [ ] 锚点是否正确生成

**解决方案**:
- 放大 `Detection Radius` 到 500 测试
- 查看 Anchor 的 `Debug Draw` 确认范围
- 检查 TiledMap 中的 anchor 对象

### 问题 3: 玩家不移动
**检查清单**:
- [ ] `RigidBody2D` 组件是否存在
- [ ] `[Grapple] 开始钩爪！` 日志是否出现
- [ ] 是否有 `[Grapple] 到达目标` 日志

**解决方案**:
- 确认 RigidBody2D 已启用
- 增大 `Reach Distance` 到 50
- 检查物理系统是否正常工作

### 问题 4: 移动方向错误
**检查清单**:
- [ ] `[Grapple] 目标锚点` 日志中的锚点名称
- [ ] 锚点的世界坐标是否正确
- [ ] 计算方向向量是否正确

**解决方案**:
- 查看日志中的锚点名称
- 检查 TiledMap 中 anchor 对象的位置
- 验证 `Vec3.distance` 计算结果

### 问题 5: 速度异常
**检查清单**:
- [ ] `Grapple Speed` 是否设置合理
- [ ] 是否有物理系统错误
- [ ] RigidBody2D 的 gravityScale 是否影响

**解决方案**:
- 调整 `Grapple Speed` 到 10-20 范围
- 检查控制台是否有物理错误
- 尝试设置 `gravityScale = 0` 测试

### 问题 6: 钩爪后无法冲刺
**检查清单**:
- [ ] `Reset Dash On Grapple` 是否勾选
- [ ] 是否有 `[Grapple] 冲刺次数已重置` 日志
- [ ] PlayerController 组件是否正确加载

**解决方案**:
- 勾选 `Reset Dash On Grapple` 属性
- 查看日志确认 `[Grapple] 未找到 PlayerController 组件` 错误
- 确保 Player 节点上同时有 PlayerController 和 GrappleController 组件

### 问题 7: 钩爪时玩家仍然下坠
**检查清单**:
- [ ] 是否有 `[Grapple] 已禁用重力` 日志
- [ ] `gravityScale` 是否正确设置为 0
- [ ] 物理系统是否正常工作

**解决方案**:
- 查看日志确认重力已禁用
- 检查 RigidBody2D 组件是否启用
- 确认物理引擎正常运行

### 问题 8: 钩爪加速过快或过慢
**检查清单**:
- [ ] `Grapple Speed` 是否设置合理
- [ ] `Grapple Force` 是否设置合理
- [ ] 物理质量是否影响加速

**解决方案**:
- 调整 `Grapple Force` 到合适范围：
  - 加速太快：降低到 20-30
  - 加速太慢：提高到 60-80
- 检查 RigidBody2D 的 mass 属性
- 调整 `Grapple Speed` 到 10-25 范围

## 启用绳索绘制（可选）

如果需要可视化绳索：

### 1. 启用 Draw Rope
在 GrappleController 组件中：
```
Draw Rope: ✓ 勾选
```

### 2. 确认 Graphics 组件
Player 节点应该自动添加 Graphics 组件

### 3. 观察绳索
- 绳索为白色线条
- 连接玩家和锚点
- 到达锚点时消失

## 性能测试

### 压力测试
1. 创建 10 个锚点
2. 持续钩爪 50 次
3. 观察帧率和内存

**预期结果**:
- 帧率保持稳定（> 60 FPS）
- 无内存泄漏
- 日志输出正常

### 覆盖率测试
1. 测试所有锚点位置
2. 测试所有角度（0°、90°、180°、270°）
3. 测试各种距离（50、150、250）

**预期结果**:
- 所有锚点可正常钩爪
- 所有角度移动方向正确
- 所有距离都能正确到达

## 下一步

完成无绳索测试后：

1. **启用绳索绘制**: 勾选 `Draw Rope`，查看视觉效果
2. **调整参数**: 根据实际体验调整速度和范围
3. **添加音效**: 在 `startGrapple` 和 `endGrapple` 添加音效
4. **添加特效**: 在锚点添加粒子效果
5. **完善UI**: 添加钩爪状态指示器

## 总结

无绳索测试的优势：
- ✓ 专注于核心移动逻辑
- ✓ 减少视觉干扰
- ✓ 更容易发现问题
- ✓ 提高测试效率

建议：
- 先完成无绳索测试，确保移动逻辑正确
- 再启用绳索绘制，测试视觉效果
- 最后调整参数，优化游戏手感
